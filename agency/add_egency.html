<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>添加代理</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport"
		content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
	<link rel="stylesheet" type="text/css" href="../css/layui/css/layui.css" />
	<link rel="stylesheet" type="text/css" href="../css/management_table.css" />
</head>

<body>
	<div class="layui-fluid">
		<div class="layui-row">
			<div class="layui-card">
				<div class="layui-card-header">
					<a href="agency.html" class="list-nav"><i class="layui-icon layui-icon-left"></i>代理管理</a>
					<span lay-separator="">/</span>
					<a><cite>添加代理</cite></a>
				</div>
				<div class="layui-card-body">
					<div class="layui-tab-item layui-show">
						<form class="layui-form" lay-filter="sub_form">
							<div class="agency-title">基本信息</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">登录账号</label>
								<div class="layui-input-inline">
									<input type="text" name="account" autocomplete="off"
										class="layui-input wd250 l_left" lay-verify="required|phone" />
									<span class="Validform_checktip">*代理商手机号</span>
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">代理商</label>
								<div class="layui-input-inline">
									<input type="text" name="agent_name" autocomplete="off"
										class="layui-input wd250 l_left" lay-verify="required" />
									<span class="Validform_checktip">*代理商名称</span>
								</div>
							</div>
							<div class="layui-form-item" style="display: none">
								<label class="layui-form-label l_width">公司名称</label>
								<div class="layui-input-inline">
									<input type="text" name="cor_name" autocomplete="off"
										class="layui-input wd250 l_left" />
									<span class="Validform_checktip">*代理商公司名称</span>
								</div>
							</div>
							<div class="layui-form-item" id="jf">
								<label class="layui-form-label l_width">上级代理</label>
								<div class="layui-input-inline">
									<select id="pare" name="pare" lay-filter="pare">
										<option value="">请选择</option>
										<option value="0">无上级</option>
									</select>
								</div>
							</div>
							<div class="layui-form-item" id="staff_from">
								<label class="layui-form-label l_width">员工来源</label>
								<div class="layui-input-inline">
									<select name="Person" id="Person">
										<option value="0" selected="">选择员工</option>
									</select>
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">代理类型</label>
								<div class="layui-input-inline">
									<input type="radio" name="proxy_type" lay-filter="proxy_type" value="1" title="贴牌">
									<input type="radio" name="proxy_type" lay-filter="proxy_type" value="0" title="普通"
										checked>
								</div>
							</div>
							<div class="layui-form-item" id="yuming" style="display: none">
								<label class="layui-form-label l_width">代理域名</label>
								<div class="layui-input-inline">
									<input type="text" name="Fileurl" autocomplete="off"
										class="layui-input wd250 l_left" />
									<span class="Validform_checktip">*贴牌代理域名</span>
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">代理状态</label>
								<div class="layui-input-inline">
									<input type="radio" name="proxy_status" value="0" title="正常" checked>
									<input type="radio" name="proxy_status" value="1" title="风控">
									<input type="radio" name="proxy_status" value="2" title="禁用">
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">隐藏用户手机</label>
								<div class="layui-input-inline l_left">
									<input type="radio" name="phone" value="0" title="是">
									<input type="radio" name="phone" value="1" title="否" checked>
									<div class="Validform_checktip l_right">*隐藏代理的用户手机号中间4位，该代理的下级代理和员工的用户同步隐藏</div>
								</div>

							</div>
							<hr>
							<div class="agency-title">服务费成本</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">开仓服务费成本</label>
								<div class="layui-input-inline">
									<input type="text" id="open_cb" name="open_cb" autocomplete="off"
										class="layui-input wd250 l_left" lay-verify="required|number" />
									<span class="Validform_checktip">*元/张</span>
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">平仓服务费成本</label>
								<div class="layui-input-inline">
									<input type="text" id="close_cb" name="close_cb" autocomplete="off"
										class="layui-input wd250 l_left" lay-verify="required|number" />
									<span class="Validform_checktip">*元/张</span>
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">追加延期成本</label>
								<div class="layui-input-inline">
									<input type="text" id="open_deduction_cb" name="open_deduction_cb"
										autocomplete="off" class="layui-input wd250 l_left"
										lay-verify="required|number" />
									<span class="Validform_checktip">*元/张</span>
								</div>
							</div>
							<hr>
							<div class="agency-title">交易服务费</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">开仓服务费</label>
								<div class="layui-input-inline">
									<input type="text" name="open" id="open" autocomplete="off"
										lay-verify="required|number" class="layui-input wd250 l_left" />
									<span class="Validform_checktip">*元/张</span>
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">平仓服务费</label>
								<div class="layui-input-inline">
									<input type="text" name="close" id="close" autocomplete="off"
										lay-verify="required|number" class="layui-input wd250 l_left" />
									<span class="Validform_checktip">*元/张</span>
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">追加延期服务费</label>
								<div class="layui-input-inline">
									<input type="text" name="open_deduction" id="open_deduction" autocomplete="off"
										lay-verify="required|number" class="layui-input wd250 l_left" />
									<span class="Validform_checktip">*元/张</span>
								</div>
							</div>
							<div class="layui-form-item">
								<label class="layui-form-label l_width">起买张数</label>
								<div class="layui-input-inline">
									<input type="text" name="numin" id="numin" autocomplete="off"
										lay-verify="required|number" class="layui-input wd250 l_left" />
									<span class="Validform_checktip">张</span>
								</div>
							</div>
							<div class="layui-form-item layui-form-text">
								<label class="layui-form-label l_width">备注</label>
								<div class="layui-input-block">
									<textarea id="remark" name="remark" class="layui-textarea wd480"></textarea>
								</div>
							</div>
							<div class="layui-form-item layui-form-text">
								<label class="layui-form-label l_width"></label>
								<div class="layui-input-block">
									<button type="button" class="layui-btn" id="sub_btn" lay-submit=""
										lay-filter="sub_btn">确认保存</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
<script src="../css/layui/layui.js" type="text/javascript" charset="utf-8"></script>
<script src="../js/jquery-3.4.0.min.js"></script>
<script src="../js/public.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	publicMathod.token = localStorage.getItem('Token') != null ? unescape(localStorage.getItem('Token')) : publicMathod.token;
	layui.use(['form', 'element'], function () {
		var form = layui.form;
		var element = layui.element;

		//初始话服务费成本
		publicMathod.post({
			url: "api/DealConfig/GetList",
			data: { "page": 1 },
			success: function (result) {
				// $("#open_cb").val(result.Data[0].Iv);
				// $("#close_cb").val(result.Data[8].Iv);
				// $("#open_deduction_cb").val(result.Data[26].Iv);
				if (result.Status === '1') {
					for (let i = 0; i < result.Data.length; i++) {
						if (result.Data[i].Co === 'buy_cost_min') {//开仓服务费成本 最低值
							$("#open_cb").val(result.Data[i].Iv);
						}
						if (result.Data[i].Co === 'sell_cost_min') {//平仓服务费成本 最低值
							$("#close_cb").val(result.Data[i].Iv);
						}
						if (result.Data[i].Co === 'detay_cost_min') {//追加延期服务费成本 最低值
							$("#open_deduction_cb").val(result.Data[i].Iv);
						}
						if (result.Data[i].Co === 'buy_rate') {//开仓服务费 最低值
							$("#open").val(result.Data[i].Iv);
						}
						if (result.Data[i].Co === 'sale_rate') {//平仓服务费 最低值
							$("#close").val(result.Data[i].Iv);
						}
						if (result.Data[i].Co === 'detay_default') {//追加延期服务费 最低值
							$("#open_deduction").val(result.Data[i].Iv);
						}
						if (result.Data[i].Co === 'basics_number') {//起买张数
							$("#numin").val(result.Data[i].Iv);
						}
					}
				}
			}
		})

		//监听代理类型
		form.on('radio(proxy_type)', function (data) {
			if (data.value == 1) {
				$("#yuming").css("display", "block")
			} else if (data.value == 0) {
				$("#yuming").css("display", "none")
			}

		})

		//初始化上级代理
		//layer.msg("初始化成功",{icon:5});
		publicMathod.post({
			url: "api/Agents/GetTree?id=-1",
			header: { "token": publicMathod.token },
			success: function (result) {
				var str = "";
				for (var i = 0; i < result.Data.length; i++) {
					str += '<option value="' + result.Data[i].id + '">' + result.Data[i].title + '</option>';
					for (var z = 0; z < result.Data[i].ChildNodes.length; z++) {
						str += '<option value="' + result.Data[i].ChildNodes[z].id + '">&emsp;' + result.Data[i].ChildNodes[z].title + '</option>';
					}
				}
				$("#pare").append(str);
				form.render(); //更新全部
			}
		})
		//自定义验证规则
		form.verify({
			zznumber: function (value) {
				if (value.toString().trim().length == 0) return;//如果为空可以提交
				if (!publicMathod.zznumber(value.toString().trim())) {
					return '必须填写非零正整数';
				}
			}
		});
		//监听提交
		var lock = true
		form.on('submit(sub_btn)', function (data) {
			var data = data.field;
			if (lock) {
				lock = false;
				publicMathod.post({
					url: "api/Agents/Add",
					header: { "token": publicMathod.token },
					data: {
						"Id": 0,
						"AsAcount": data.account,
						"AsName": data.agent_name,
						"AsCaName": data.cor_name?data.cor_name:'',
						"PareId": parseInt(data.pare),
						"Person": data.Person ? data.Person : 0,
						"Fileurl": data.Fileurl ? data.Fileurl : '',//代理域名
						"IsLock": parseInt(data.proxy_status),
						"IhIde": parseInt(data.phone),
						"TypeId": parseInt(data.proxy_type),
						"FBuy": Number(data.open_cb),
						"FSale": Number(data.close_cb),
						"Raser": Number(data.open_deduction_cb),//追加延期服务费成本
						"Rfbuy": Number(data.open),//开仓服务费
						"Rfsale": Number(data.close),//平仓服务费
						"Ratdel": Number(data.open_deduction),//追加延期费
						"Remark": data.remark,
						"numin": parseInt(data.numin) //起买张数
					},
					success: function (result) {
						if (result.Status == 1) {
							window.location.href = "agency.html";
						} else {
							lock = true
							layer.msg(result.Msg, { icon: 5, shade: 0.8, });
						}
					}
				})
			}
			return false;
		});

		//监听下拉框
		form.on('select(pare)', function (data) {
			if (data.value === '0') {
				$('#staff_from').css('display', 'block');
				//员工来源
				publicMathod.getDropdownList("api/Agents/AgentFrom", form, $("#Person"));
				form.render();
			} else {
				$('#staff_from').css('display', 'none');
				publicMathod.post({
					url:"api/Agents/GetModel",
					data:data.value,
					success: function (result) {
					
						$("#open_cb").val(result.Data.Agent.FBuy);
						$("#close_cb").val(result.Data.Agent.FSale);
						$("#open_deduction_cb").val(result.Data.Agent.Raser);
						$("#open").val(result.Data.Agent.Rfbuy);
						$("#close").val(result.Data.Agent.Rfsale);
						$("#open_deduction").val(result.Data.Agent.Ratdel);
						$("#numin").val(result.Data.Agent.numin);
					}
				})
			}
		})
	})

</script>

</html>