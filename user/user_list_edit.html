<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>编辑用户</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" type="text/css" href="../css/layui/css/layui.css" />
    <link rel="stylesheet" type="text/css" href="../css/management_table.css" />
</head>

<body>
    <div class="layui-fluid">
        <div class="layui-row">
            <div class="layui-card">
                <div class="layui-card-header">
                    <a href="user_list.html" class="list-nav"><i class="layui-icon layui-icon-left"></i>用户列表</a>
                    <span lay-separator="">/</span>
                    <a><cite>编辑用户</cite></a>
                </div>
                <div class="layui-card-body">
                    <form class="layui-form" lay-filter="sub_form">
                        <div class="layui-form-item">
                            <label class="layui-form-label">母账户</label>
                            <div class="layui-input-inline wd250">
                                <select id="MId" name="MId">
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">用户状态</label>
                            <div class="layui-input-inline wd250">
                                <select id="Status" name="Status">
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">实名状态</label>
                            <div class="layui-input-inline">
                                <select id="NTure" name="NTure">
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">手机号码</label>
                            <div class="layui-input-inline">
                                <input type="text" id="seo_title" autocomplete="off" name="Uphe" class="layui-input ">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">登录密码</label>
                            <div class="layui-input-inline">
                                <input type="password" id="seo_keywords" name="Apass" lay-verify="password" class="layui-input wd250 l_left"
                                    autocomplete="off">
                                <span class="Validform_checktip">*请设置6-24位英文数字组合密码</span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">用户姓名</label>
                            <div class="layui-input-inline">
                                <input type="text" id="seo_title" autocomplete="off" name="UName" class="layui-input ">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">身份证号码</label>
                            <div class="layui-input-inline">
                                <input type="text" id="seo_title" autocomplete="off" name="Ic" class="layui-input ">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">推广代理</label>
                            <div class="layui-input-inline">
                                <select id="AId" name="AId" lay-filter="AId">
                                    <option value="0">请选择代理商</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">推广员工</label>
                            <div class="layui-input-inline">
                                <select id="SId" name="SId" lay-filter="SId">
                                    <option value="0" selected="selected">请选择员工</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">推荐人ID</label>
                            <div class="layui-input-inline">
                                <div style="line-height: 39px;" id="Ref"></div>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">买入收费</label>
                            <div class="layui-input-inline">
                                <input type="text" id="seo_title" autocomplete="off" name="BRate"
                                    class="layui-input wd250 l_left">
                                <span class="Validform_checktip">元 *开仓每张服务费，0为系统默认收费</span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">平仓收费</label>
                            <div class="layui-input-inline">
                                <input type="text" id="seo_title" autocomplete="off" name="SRate"
                                    class="layui-input wd250 l_left">
                                <span class="Validform_checktip">元 *平仓每张服务费，0为系统默认收费</span>
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">起买张数</label>
                            <div class="layui-input-inline">
                                <input type="text" id="seo_title" autocomplete="off" name="NBuyin"
                                    class="layui-input wd250 l_left">

                            </div>
                        </div>
                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label">备注</label>
                            <div class="layui-input-block">
                                <textarea id="zhaiyao" name="Rmk" class="layui-textarea wd480"></textarea>
                            </div>
                        </div>
                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label"></label>
                            <div class="layui-input-block">
                                <button type="button" class="layui-btn" id="sub_btn" lay-submit=""
                                    lay-filter="sub_btn">确认提交</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="../css/layui/layui.js" type="text/javascript" charset="utf-8"></script>
    <script src="../js/jquery-3.4.0.min.js"></script>
    <script src="../js/public.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
	publicMathod.token = localStorage.getItem('Token') != null ? unescape(localStorage.getItem('Token')) : publicMathod.token;
        var id;
        layui.use(['form', 'element', 'jquery'], function () {
            var form = layui.form;
            var element = layui.element;
            var $ = layui.jquery;

            var id = publicMathod.getUrlParam("id");
            //原始的代理Id
            var aid = 0;

            //初始化母账户下拉框
            publicMathod.getDropdownList("api/Tool/GetMasterList", form, $("#MId"));

            //初始化用户状态下拉框
            publicMathod.getDropdownList("api/Tool/GetMobileUserStatus", form, $("#Status"));

            //初始化实名状态下拉框 
            publicMathod.getDropdownList("api/Tool/GetMobileUserRealStatus", form, $("#NTure"));

            //初始化代理商下拉框
            publicMathod.getAllAgency("api/Agents/GetAllTree", form, $("#AId"));

            //初始化推广员工 对应推广代理 推广人Id 联动
            var staff = [];
            publicMathod.post({
                url: "api/user/GetStaffByUserId",
                data: id,
                success: function (result) {
                    staff =  result.Data ? result.Data : [];
                    var str = "";
                    for (var i = 0; i < result.Data.length; i++) {
                        str += '<option value="' + result.Data[i].Id + '">' + result.Data[i].Name + '</option>';
                    }
                    $("#SId").append(str);
                    form.render(); //更新全部
                }
            });


            //监听代理商下拉框选择事件
            form.on('select(AId)', function (data) {
                if (data.value == aid) {
                    //选择的代理没有发生变化
                } else {
                    //代理发生变化，更新原始aid 更新员工数据 更新推广人Id
                    aid = data.value;
                    $("#Ref").text("A" + aid + "B0C0");

                    publicMathod.post({
                        url: "api/user/GetStaffByAId",
                        data: aid,
                        success: function (result) {
                            //console.log(result);
                            $("#SId").html("");
                            var str = '<option value="0" selected="selected">请选择员工</option>';
                            for (var i = 0; i < result.Data.length; i++) {
                                str += '<option value="' + result.Data[i].Id + '">' + result.Data[i].Name + '</option>';
                            }
                            $("#SId").append(str);
                            form.render(); //更新全部
                        }
                    });
                }
            });

            //监听员工下拉框选择事件
            form.on('select(SId)', function (data) {
                $("#Ref").text("A" + aid + "B" + data.value + "C0");
            })

            //初始化表单
            setTimeout(() => {
                publicMathod.post({
                    url: "api/User/GetModel?id=" + id,
                    success: function (data) {
                        var Sidd = 0;
                       for (let i = 0; i < staff.length; i++) {
                           if(staff[i].Id== data.Data.SId){
                                Sidd =  data.Data.SId
                           }
                           
                       }
                        
                        if (data.Status == "1") {
                            //表单初始化
                            form.val("sub_form", {
                                "MId": data.Data.MId,
                                "Status": data.Data.Status,
                                "NTure": data.Data.NTure,
                                "Uphe": data.Data.Uphe,
                                "Apass": data.Data.Apass,
                                "UName": data.Data.UName,
                                "Ic": data.Data.Ic,
                                "AId": data.Data.AId,
                                "SId": Sidd,
                                "BRate": data.Data.BRate,
                                "SRate": data.Data.SRate,
                                "NBuyin": data.Data.NBuyin,
                                "Rmk": data.Data.Rmk,
                            })
                            if(data.Data.Ref){
                                $("#Ref").text(data.Data.Ref);
                            }else{
                                $("#Ref").text("A"+data.Data.AId+"B"+Sidd+"C0");
                            }
                           

                            //给原始代理Id赋值
                            aid = data.Data.AId;

                            form.render(); //更新全部
                        }
                        else { layer.msg("获取数据失败，请重试！", { icon: 5 }) }


                    }
                });
            }, 100);



            //自定义验证规则
            form.verify({
                zznumber: function (value) {
                    if (value.toString().trim().length == 0) return;//如果为空可以提交
                    if (!publicMathod.zznumber(value.toString().trim())) {
                        return '必须填写非零正整数';
                    }
                },
                password: function(value) {
                    var par = /^([a-zA-Z]+\d+)|(\d+[a-zA-Z]+)$/;
					if (!par.exec(value)) {
						return '密码设置格式不正确';
					}
				}
                
            });


            //监听提交
            var lock = true
            form.on('submit(sub_btn)', function (data) {
                var data = data.field;
                if(lock){
				lock = false
                publicMathod.post({
                    url: "api/User/Edit",
                    data: {
                        "Id":parseInt(id) ,
                        "MId": parseInt(data.MId),
                        "Status": parseInt(data.Status),
                        "NTure": parseInt(data.NTure),
                        "Uphe": data.Uphe,
                        "Apass": data.Apass,
                        "UName": data.UName,
                        "Ic": data.Ic,
                        "AId": parseInt(data.AId),
                        "SId": parseInt(data.SId),
                        "Balance": 0,
                        "Ref": $("#Ref").text(),
                        "NBuyin": parseInt(data.NBuyin),
                        "BRate": Number(data.BRate),
                        "SRate": Number(data.SRate),
                        "Rmk": data.Rmk
                    },
                    success: function (result) {
                        if (result.Status == "1") {
                            layer.msg(result.Msg, { icon: 1, shade: 0.4, time: 1000 }, function () { window.location.href = "user_list.html"; });

                        } else {
                            lock = true
                            layer.msg(result.Msg, { icon: 5 });
                        }
                    }
                })
            }
                return false;
            });


        })

    </script>
</body>

</html>